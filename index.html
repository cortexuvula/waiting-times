<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Your BC MLA About Medical Wait Times</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 300px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #95a5a6;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-copy {
            background: #27ae60;
            margin-left: 10px;
        }

        .btn-copy:hover {
            background: #229954;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .info-box p {
            margin: 5px 0;
            color: #555;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #c0392b;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #155724;
        }

        .help-text {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .step-item {
            flex: 1;
            text-align: center;
            position: relative;
            color: #bdc3c7;
            font-size: 14px;
            font-weight: 600;
        }

        .step-item.active {
            color: #667eea;
        }

        .step-item.completed {
            color: #27ae60;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item.selected {
            background-color: #e8eaf6;
        }

        .autocomplete-item strong {
            color: #2c3e50;
        }

        .autocomplete-item small {
            display: block;
            color: #7f8c8d;
            font-size: 13px;
            margin-top: 3px;
        }

        .autocomplete-loading {
            padding: 12px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Contact Your BC MLA About Medical Wait Times</h1>
        <p class="subtitle">Find your representative and send them a message about healthcare concerns</p>

        <div class="step-indicator">
            <div class="step-item active" id="indicator-1">1. Enter Address</div>
            <div class="step-item" id="indicator-2">2. Confirm MLA</div>
            <div class="step-item" id="indicator-3">3. Email</div>
        </div>

        <!-- Step 1: Address Input -->
        <div class="step active" id="step1">
            <div class="form-group">
                <label for="address">Enter Your Address or Postal Code</label>
                <div class="autocomplete-container">
                    <input type="text" id="address" placeholder="e.g., 123 Main St, Vancouver, BC or V6B 1A1" autocomplete="off">
                    <div class="autocomplete-suggestions" id="addressSuggestions"></div>
                </div>
                <p class="help-text">Enter your full address or just your postal code (format: V6B1A1 or V6B 1A1)</p>
            </div>
            <button class="btn" onclick="findMLA()">Find My MLA</button>

            <div class="loading" id="loading1">
                <div class="spinner"></div>
                <p>Searching for your MLA...</p>
            </div>

            <div id="error1"></div>
        </div>

        <!-- Step 2: Confirm MLA -->
        <div class="step" id="step2">
            <div class="info-box" id="mlaInfo">
                <h3>Your MLA Information</h3>
                <p><strong>Name:</strong> <span id="mlaName"></span></p>
                <p><strong>Electoral District:</strong> <span id="mlaDistrict"></span></p>
                <p><strong>Party:</strong> <span id="mlaParty"></span></p>
                <p><strong>Email:</strong> <span id="mlaEmail"></span></p>
            </div>

            <p style="margin: 20px 0;">Is this information correct?</p>

            <button class="btn" onclick="confirmMLA()">Yes, Generate Email</button>
            <button class="btn btn-secondary" onclick="goBack(1)">No, Try Again</button>
        </div>

        <!-- Step 3: Email -->
        <div class="step" id="step3">
            <div class="info-box">
                <h3>Email Preview</h3>
                <p>Review the email below and copy it to send from your email provider.</p>
            </div>

            <div class="form-group">
                <label for="emailSubject">Subject</label>
                <input type="text" id="emailSubject" value="Urgent: Addressing Excessive Medical Wait Times in BC" readonly>
            </div>

            <div class="form-group">
                <label for="emailBody">Email Content</label>
                <textarea id="emailBody" readonly></textarea>
            </div>

            <div id="copySuccess"></div>

            <button class="btn btn-copy" onclick="copyEmail()">Copy Email</button>
            <button class="btn btn-secondary" onclick="goBack(1)">Back</button>
            <button class="btn btn-secondary" onclick="startOver()">Start Over</button>
        </div>
    </div>

    <script>
        let mlaData = null;
        let autocompleteTimeout = null;
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];

        // Autocomplete functionality
        const addressInput = document.getElementById('address');
        const suggestionsContainer = document.getElementById('addressSuggestions');

        addressInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();

            // Clear previous timeout
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }

            // Hide suggestions if query is too short
            if (query.length < 3) {
                hideSuggestions();
                return;
            }

            // Show loading state
            suggestionsContainer.innerHTML = '<div class="autocomplete-loading">Searching addresses...</div>';
            suggestionsContainer.classList.add('active');

            // Debounce API call
            autocompleteTimeout = setTimeout(() => {
                fetchAddressSuggestions(query);
            }, 300);
        });

        addressInput.addEventListener('keydown', function(e) {
            const suggestionItems = suggestionsContainer.querySelectorAll('.autocomplete-item');

            if (suggestionItems.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                updateSelectedSuggestion(suggestionItems);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(suggestionItems);
            } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
                e.preventDefault();
                selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        async function fetchAddressSuggestions(query) {
            try {
                // Add British Columbia, Canada to the query for better results
                const searchQuery = `${query}, British Columbia, Canada`;
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?` +
                    `q=${encodeURIComponent(searchQuery)}` +
                    `&format=json` +
                    `&limit=5` +
                    `&addressdetails=1` +
                    `&countrycodes=ca`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions');
                }

                const data = await response.json();
                currentSuggestions = data;
                displaySuggestions(data);
            } catch (error) {
                console.error('Autocomplete error:', error);
                hideSuggestions();
            }
        }

        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                suggestionsContainer.innerHTML = '<div class="autocomplete-loading">No addresses found</div>';
                return;
            }

            suggestionsContainer.innerHTML = '';
            selectedSuggestionIndex = -1;

            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';

                const displayName = suggestion.display_name;
                const parts = displayName.split(', ');
                const mainAddress = parts.slice(0, 2).join(', ');
                const subAddress = parts.slice(2).join(', ');

                item.innerHTML = `
                    <strong>${mainAddress}</strong>
                    <small>${subAddress}</small>
                `;

                item.addEventListener('click', () => selectSuggestion(suggestion));
                item.addEventListener('mouseenter', () => {
                    selectedSuggestionIndex = index;
                    updateSelectedSuggestion(suggestionsContainer.querySelectorAll('.autocomplete-item'));
                });

                suggestionsContainer.appendChild(item);
            });

            suggestionsContainer.classList.add('active');
        }

        function updateSelectedSuggestion(items) {
            items.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectSuggestion(suggestion) {
            addressInput.value = suggestion.display_name;
            hideSuggestions();
        }

        function hideSuggestions() {
            suggestionsContainer.classList.remove('active');
            suggestionsContainer.innerHTML = '';
            selectedSuggestionIndex = -1;
            currentSuggestions = [];
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                hideSuggestions();
            }
        });

        async function findMLA() {
            const address = document.getElementById('address').value.trim();

            if (!address) {
                showError('Please enter an address or postal code', 'error1');
                return;
            }

            // Clear previous errors
            document.getElementById('error1').innerHTML = '';

            // Show loading
            document.getElementById('loading1').classList.add('active');
            document.querySelector('#step1 .btn').disabled = true;

            try {
                // Try to extract a postal code from anywhere in the input
                const postalCodePattern = /[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d/;
                const postalCodeMatch = address.match(postalCodePattern);

                let representatives;

                if (postalCodeMatch) {
                    // Use postal code if found (most accurate)
                    const cleanPostalCode = postalCodeMatch[0].replace(/\s/g, '').toUpperCase();
                    representatives = await searchByPostalCode(cleanPostalCode);
                } else {
                    // Geocode the address if no postal code found
                    const coords = await geocodeAddress(address);
                    representatives = await searchByCoordinates(coords.lat, coords.lng);
                }

                if (representatives && representatives.length > 0) {
                    mlaData = representatives[0];
                    displayMLAInfo();
                    moveToStep(2);
                } else {
                    showError('No MLA found for this location. Please verify your address or postal code.', 'error1');
                }

            } catch (error) {
                showError(error.message || 'An error occurred while searching. Please try again.', 'error1');
            } finally {
                document.getElementById('loading1').classList.remove('active');
                document.querySelector('#step1 .btn').disabled = false;
            }
        }

        async function searchByPostalCode(postalCode) {
            const response = await fetch(`https://represent.opennorth.ca/postcodes/${postalCode}/`);

            if (!response.ok) {
                throw new Error('Could not find electoral district for this postal code');
            }

            const data = await response.json();
            const allReps = data.representatives_centroid || data.representatives_concordance || [];

            // Filter for BC MLAs only (elected_office === "MLA")
            const mlas = allReps.filter(rep => rep.elected_office === 'MLA');
            return mlas;
        }

        async function searchByCoordinates(lat, lng) {
            const response = await fetch(`https://represent.opennorth.ca/representatives/?point=${lat},${lng}`);

            if (!response.ok) {
                throw new Error('Could not find MLA for this location');
            }

            const data = await response.json();
            const allReps = data.objects || [];

            // Filter for BC MLAs only (elected_office === "MLA")
            const mlas = allReps.filter(rep => rep.elected_office === 'MLA');
            return mlas;
        }

        async function geocodeAddress(address) {
            // Using Nominatim (OpenStreetMap) for free geocoding
            const query = `${address}, British Columbia, Canada`;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);

            if (!response.ok) {
                throw new Error('Could not geocode address');
            }

            const data = await response.json();

            if (data.length === 0) {
                throw new Error('Address not found. Please try a more specific address or use your postal code.');
            }

            return {
                lat: data[0].lat,
                lng: data[0].lon
            };
        }

        function displayMLAInfo() {
            document.getElementById('mlaName').textContent = mlaData.name || 'N/A';
            document.getElementById('mlaDistrict').textContent = mlaData.district_name || 'N/A';
            document.getElementById('mlaParty').textContent = mlaData.party_name || 'N/A';

            // Extract email from offices array or direct email field
            let email = 'Not available';
            if (mlaData.email) {
                email = mlaData.email;
            } else if (mlaData.offices && mlaData.offices.length > 0) {
                for (let office of mlaData.offices) {
                    if (office.email) {
                        email = office.email;
                        break;
                    }
                }
            }
            document.getElementById('mlaEmail').textContent = email;
        }

        function confirmMLA() {
            generateEmail();
            moveToStep(3);
        }

        function generateEmail() {
            const mlaName = mlaData.name || 'MLA';
            const district = mlaData.district_name || 'your district';

            const emailBody = `Dear ${mlaName},

I am writing to you as a constituent in ${district} to express my deep concern about the excessive medical wait times that British Columbians are currently experiencing. These delays are having a significant impact on the health and well-being of our community.

The current situation is unacceptable:

• Patients are waiting months, sometimes years, for necessary medical procedures and specialist appointments
• Emergency room wait times continue to be among the longest in Canada
• Many British Columbians do not have access to a family doctor, making preventive care and early diagnosis difficult
• The backlog created during the pandemic has not been adequately addressed
• Healthcare workers are overwhelmed and experiencing burnout, which further exacerbates the problem

These delays are not just inconvenient—they are life-altering. People are suffering in pain, conditions are worsening while patients wait, and in some cases, lives are being lost due to delayed care.

I urge you to take immediate action on this critical issue:

1. Increase funding and resources for healthcare infrastructure
2. Implement strategies to recruit and retain healthcare professionals
3. Reduce administrative barriers that slow down patient care
4. Invest in innovative solutions to clear surgical and diagnostic backlogs
5. Improve access to primary care for all British Columbians

As my elected representative, I ask that you make reducing medical wait times a top priority and keep your constituents informed about the concrete steps being taken to address this crisis.

I would appreciate a response outlining what actions you and the government are taking to resolve this urgent issue.

Thank you for your attention to this matter.

Sincerely,
[Your Name]
[Your Address]
[Your Email]
[Your Phone Number]`;

            document.getElementById('emailBody').value = emailBody;
        }

        function copyEmail() {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const mlaEmail = document.getElementById('mlaEmail').textContent;

            // Copy email body to clipboard
            navigator.clipboard.writeText(body).then(() => {
                const successDiv = document.getElementById('copySuccess');
                successDiv.innerHTML = `<div class="success">Email content copied to clipboard! You can now paste it into your email client.<br><strong>Send to:</strong> ${mlaEmail}</div>`;

                setTimeout(() => {
                    successDiv.innerHTML = '';
                }, 5000);
            }).catch(err => {
                showError('Failed to copy to clipboard. Please manually select and copy the text.', 'copySuccess');
            });
        }

        function moveToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });

            // Show target step
            document.getElementById(`step${stepNumber}`).classList.add('active');

            // Update indicators
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`indicator-${i}`);
                indicator.classList.remove('active', 'completed');

                if (i < stepNumber) {
                    indicator.classList.add('completed');
                } else if (i === stepNumber) {
                    indicator.classList.add('active');
                }
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goBack(steps) {
            const currentStep = Array.from(document.querySelectorAll('.step')).findIndex(step =>
                step.classList.contains('active')
            ) + 1;
            moveToStep(currentStep - steps);
        }

        function startOver() {
            document.getElementById('address').value = '';
            mlaData = null;
            moveToStep(1);
        }

        function showError(message, elementId) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        // Allow Enter key to submit
        document.getElementById('address').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                findMLA();
            }
        });
    </script>
</body>
</html>
